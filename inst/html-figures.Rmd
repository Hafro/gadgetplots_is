---
title: "Gadget model output"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
params: 
  fit: fit
editor_options: 
  chunk_output_type: console
---

Annual plot
=======================================================================

Column {data-width=500}
-----------------------------------------------------------------------

### Catches

```{r}
plotly::ggplotly(plot_catch(fit)) %>% 
  plotly::layout(legend=list(x=0, y = 1, 
                             xanchor='left',
                             yanchor='bottom',
                             orientation='h'))
```

### F

```{r}
plotly::ggplotly(plot_f(fit) + ggplot2::theme(legend.position = "none"))
```


Column {data-width=500}
-----------------------------------------------------------------------

### Recruitment

```{r}
plotly::ggplotly(plot_rec(fit) + ggplot2::theme(legend.position = "none"))
```

### Biomass

```{r}
plotly::ggplotly(
  plot_biomass(fit, total = TRUE) + ggplot2::theme(legend.position = "none"))
```

Catches
=======================================================================

Row
-----------------------------------------------------------------------

### Catches

```{r, fig.height = 10, fig.width = 12.5}
plot_catch(fit, type = "fleet", base_size = 16) +
  ggplot2::guides(fill=ggplot2::guide_legend(nrow=2,byrow=TRUE)) +
  ggplot2::theme(legend.position = "bottom")

# plotly::subplot(plot_catch(fit, type = "fleet"),
#                 plot_catch(fit, type = "hr"),
#                 margin = 0.05,
#                 titleX = TRUE,
#                 titleY = TRUE) # %>% 
# plotly::layout(legend=list(x=0, y = 1, 
#                            xanchor='left',
#                            yanchor='bottom',
#                            orientation='h')) 

```

Row
-----------------------------------------------------------------------

### Harvest rate

```{r, fig.height = 10, fig.width = 12.5}
plot_catch(fit, type = "hr", base_size = 16) +
  ggplot2::guides(fill=ggplot2::guide_legend(nrow=2,byrow=TRUE)) +
  ggplot2::theme(legend.position = "bottom")
```


Survey indices
=======================================================================

```{r}
plotly::ggplotly(plot_si(fit))
```


Catch distributions 
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------

```{r, echo = FALSE}
x <- plot_catchdist(fit, base_size = 16)
```

```{r, echo = FALSE, fig.height = 10, fig.width = 25, results='asis'}

for(i in seq_along(x)) {
  
  cat("  \n###",  names(x)[i], "  \n")
  print(x[[i]])
  cat("  \n")
}

```

Stock distribution 
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------

### Model fit

```{r, fig.height = 12, fig.width = 25}
plot_stockdist(fit, type = "model_fit", stocks = "separate", base_size = 16)

# plotly::subplot(lapply(x, function(k) {
#   k + ggplot2::theme(legend.position = "none")
# }),
# nrows = 2
# )

```

### Stock composition

```{r, fig.height = 12, fig.width = 25}
plot_stockdist(fit, type = "stock_composition", base_size = 16)
```

Suitability
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------

```{r, echo = FALSE}
x <- plot_suitability(fit, fleets = NULL, base_size = 16)
```

```{r, echo = FALSE, fig.height = 12, fig.width = 25, results='asis'}

for(i in seq_along(x)) {
  
  cat("  \n###",  names(x)[i], "  \n")
  print(x[[i]] + 
          ggplot2::theme(legend.position = "top")
  )
  cat("  \n")
}

```

Age-length
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------

```{r, echo = FALSE}
x <- plot_agelength(fit, base_size = 16)
# x <- lapply(x, function(k) plotly::ggplotly(k))
```

```{r, echo = FALSE, fig.height = 12, fig.width = 25, results='asis'}

for(i in seq_along(x)) {
  
  cat("  \n###",  names(x)[i], "  \n")
  print(x[[i]])
  cat("  \n")
}
```

### Growth

```{r, fig.height = 12, fig.width = 25}
plot_growth(fit, base_size = 16) + ggplot2::theme(legend.position = "none")
```

Age composition 
=======================================================================

Column 
-----------------------------------------------------------------------

```{r, fig.width=25, fig.height=15}
plot_agecomp(fit, base_size = 16)
```

Residuals & likelihood
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------

### Residuals

```{r,fig.height = 10, fig.width = 25}
plot_resid(fit, base_size = 16)
```

### Raw likelihood

```{r, fig.height = 10, fig.width = 25}
plot_likelihood(fit, base_size = 16)
```

### Weighted likelihood

```{r, fig.height = 10, fig.width = 25}
plot_likelihood(fit, base_size = 16, type = "weighted")
```

### Total

```{r}
plot_likelihood(fit, base_size = 14, type = "pie")
```

Parameters
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------

### Relative to boundaries

```{r, fig.width=14.5, fig.height=12}
# plotly::ggplotly(plot_param(fit))
```

### Weights

```{r}
plot_weight(fit)
```

### Growth parameters & M

```{r}
DT::datatable(fit$params %>% 
                dplyr::filter(grepl("K$|Linf|recl$|M$", .data$switch)) %>% 
                dplyr::arrange(switch),
              options = list(pageLength = 500)) %>%
  DT::formatRound(columns=c('value'), digits=3)
```

### All parameters 

```{r}
DT::datatable(fit$params, options = list(pageLength = 500)) %>%
  DT::formatRound(columns=c('value'), digits=3)
```
